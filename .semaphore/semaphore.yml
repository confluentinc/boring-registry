version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1

fail_fast:
  cancel:
    when: "true"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'main' and branch !~ '[0-9]+\\.[0-9]+\\.x'"
    processing: parallel

global_job_config:
  prologue:
    commands:
      - checkout
      - sem-version go 1.23.10

blocks:
  - name: Test & Build
    dependencies: []
    run:
      # don't run the tests on non-functional changes...
      when: "change_in('/', {exclude: ['/.deployed-versions/', '.github/'], default_branch: 'main'})"
    task:
      jobs:
        - name: Test & Build
          commands:
            - go test ./...
            - make build

  - name: "Auto Release and Deploy to ECR"
    dependencies: ["Test & Build"]
    run:
      when: "branch = 'main'"
    task:
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "confluentinc/boring-registry"
      jobs:
        - name: "Bump version and Publish Docker image"
          commands:
            - curl -sfL https://goreleaser.com/static/run > /tmp/goreleaser && chmod +x /tmp/goreleaser && sudo mv /tmp/goreleaser /usr/local/bin/goreleaser
            - ./auto-release.sh
            - ./helm-release.sh

  - name: "Dev Release to DEV ECR"
    dependencies: ["Test & Build"]
    run:
      when: "branch != 'main'"
    task:
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/dev/confluentinc/boring-registry"
      jobs:
        - name: "Publish Dev Docker image"
          commands:
            - curl -sfL https://goreleaser.com/static/run > /tmp/goreleaser && chmod +x /tmp/goreleaser && sudo mv /tmp/goreleaser /usr/local/bin/goreleaser
            - echo "Dev build for branch: $SEMAPHORE_GIT_BRANCH"
            - export INTERNAL_VERSION="dev-$(echo $SEMAPHORE_GIT_BRANCH | sed 's/[^a-zA-Z0-9]/-/g')-$(echo $SEMAPHORE_GIT_SHA | cut -c1-8)"
            - export GORELEASER_CURRENT_TAG="dev-v$INTERNAL_VERSION"
            - echo "Building and pushing dev version: $INTERNAL_VERSION"
            - git tag "$GORELEASER_CURRENT_TAG" || echo "Tag already exists, continuing..."
            - goreleaser release --config .goreleaser-internal.yml --clean --skip=validate
