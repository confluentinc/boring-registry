version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1

fail_fast:
  cancel:
    when: "true"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'master' and branch !~ '[0-9]+\\.[0-9]+\\.x'"
    processing: parallel

global_job_config:
  prologue:
    commands:
      - checkout
      - sem-version go 1.23.10

blocks:
  - name: Test & Build
    dependencies: []
    run:
      # don't run the tests on non-functional changes...
      when: "change_in('/', {exclude: ['/.deployed-versions/', '.github/'], default_branch: 'master'})"
    task:
      jobs:
        - name: Test & Build
          commands:
            - go test ./...
            - make build
            - "curl -H \"Authorization: Bearer $SEMAPHORE_OIDC_TOKEN\" https://terraform-registry.stage.dp.confluent.io/.well-known/terraform.json"
            - mkdir -p ~/.terraform.d
            - echo '{"credentials":{"terraform-registry.stage.dp.confluent.io":{"token":"$SEMAPHORE_OIDC_TOKEN"}}}' > ~/.terraform.d/credentials.tfrc.json
            - "cat ~/.terraform.d/credentials.tfrc.json"
            - "curl -H \"Authorization: Bearer $(jq -r '.credentials.\"terraform-registry.stage.dp.confluent.io\".token' ~/.terraform.d/credentials.tfrc.json)\" https://terraform-registry.stage.dp.confluent.io/.well-known/terraform.json"
            - "curl -H \"Authorization: Bearer $SEMAPHORE_OIDC_TOKEN\" https://terraform-registry.stage.dp.confluent.io/v1/modules/boring_registry_test/example/aws/versions"
            - cd example_to_download
            - terraform init -backend=false
