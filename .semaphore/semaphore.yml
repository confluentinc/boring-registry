version: v1.0
name: build-test-release
agent:
  machine:
    type: s1-prod-ubuntu24-04-amd64-1

fail_fast:
  cancel:
    when: "true"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'main' and branch !~ '[0-9]+\\.[0-9]+\\.x'"
    processing: parallel

global_job_config:
  prologue:
    commands:
      - checkout

blocks:
  - name: Test & Build
    dependencies: []
    run:
      # don't run the tests on non-functional changes...
      when: "change_in('/', {exclude: ['/.deployed-versions/', '.github/'], default_branch: 'main'})"
    task:
      jobs:
        - name: Test & Build
          commands:
            - sem-version go 1.23.10
            - go test ./...
            - make build

  - name: "Auto Release and Version Bump"
    dependencies: ["Test & Build"]
    run:
      when: "branch = 'main'"
    task:
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/prod/confluentinc/boring-registry"
      jobs:
        - name: "Bump version and prepare release"
          commands:
            - ./auto-release.sh

  - name: "Prod Build AMD64"
    dependencies: ["Auto Release and Version Bump"]
    run:
      when: "branch = 'main'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-amd64-1
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/prod/confluentinc/boring-registry"
        - name: BUILD_ARCH
          value: "amd64"
      jobs:
        - name: "Build and Push Production AMD64 Image"
          commands:
            - "echo \"Building production AMD64 image with Docker\""
            - "export INTERNAL_VERSION=$(cat INTERNAL_VERSION)"
            - "docker build --platform linux/amd64 -t \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64\" --build-arg VERSION=\"${INTERNAL_VERSION}\" --build-arg GIT_COMMIT=\"${SEMAPHORE_GIT_SHA}\" --build-arg BUILD_TIMESTAMP=\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" ."
            - "docker push \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64\""
            - sign-images "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64"

  - name: "Prod Build ARM64"
    dependencies: ["Auto Release and Version Bump"]
    run:
      when: "branch = 'main'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-arm64-1
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/prod/confluentinc/boring-registry"
        - name: BUILD_ARCH
          value: "arm64"
      jobs:
        - name: "Build and Push Production ARM64 Image"
          commands:
            - "echo \"Building production ARM64 image with Docker\""
            - "export INTERNAL_VERSION=$(cat INTERNAL_VERSION)"
            - "docker build --platform linux/arm64 -t \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64\" --build-arg VERSION=\"${INTERNAL_VERSION}\" --build-arg GIT_COMMIT=\"${SEMAPHORE_GIT_SHA}\" --build-arg BUILD_TIMESTAMP=\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" ."
            - "docker push \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64\""
            - sign-images "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64"

  - name: "Prod Helm"
    dependencies: ["Auto Release and Version Bump"]
    run:
      when: "branch = 'main'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-arm64-0
      jobs:
        - name: "Prod Helm"
          commands:
            - export ENV=prod
            - ./helm-release.sh

  - name: "Prod Create Manifest"
    dependencies: ["Prod Build AMD64", "Prod Build ARM64"]
    run:
      when: "branch = 'main'"
    task:
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/prod/confluentinc/boring-registry"
      jobs:
        - name: "Create Production Multi-Platform Manifest"
          commands:
            - "echo \"Creating production manifest\""
            - "export INTERNAL_VERSION=$(cat INTERNAL_VERSION)"
            - "docker manifest create \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}\" \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64\" \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64\""
            - "docker manifest push \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}\""
            - docker pull "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}"
            - sign-images "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}"

  - name: "Dev Build AMD64"
    dependencies: ["Test & Build"]
    run:
      when: "branch != 'main'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-amd64-1
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/dev/confluentinc/boring-registry"
        - name: PLATFORM
          value: "amd64"
      jobs:
        - name: "Build and Push AMD64 Image"
          commands:
            - "echo \"Building AMD64 image for branch: $SEMAPHORE_GIT_WORKING_BRANCH\""
            - "export INTERNAL_VERSION=\"$(echo $SEMAPHORE_GIT_WORKING_BRANCH | sed 's/[^a-zA-Z0-9]/-/g')-$(echo $SEMAPHORE_GIT_SHA | cut -c1-8)\""
            - "docker build --platform linux/amd64 -t \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64\" --build-arg VERSION=\"${INTERNAL_VERSION}\" --build-arg GIT_COMMIT=\"${SEMAPHORE_GIT_SHA}\" --build-arg BUILD_TIMESTAMP=\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" ."
            - "docker push \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64\""
            - sign-images "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64"

  - name: "Dev Build ARM64"
    dependencies: ["Test & Build"]
    run:
      when: "branch != 'main'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-arm64-1
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/dev/confluentinc/boring-registry"
        - name: PLATFORM
          value: "arm64"
      jobs:
        - name: "Build and Push ARM64 Image"
          commands:
            - "echo \"Building ARM64 image for branch: $SEMAPHORE_GIT_WORKING_BRANCH\""
            - "export INTERNAL_VERSION=\"$(echo $SEMAPHORE_GIT_WORKING_BRANCH | sed 's/[^a-zA-Z0-9]/-/g')-$(echo $SEMAPHORE_GIT_SHA | cut -c1-8)\""
            - "docker build --platform linux/arm64 -t \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64\" --build-arg VERSION=\"${INTERNAL_VERSION}\" --build-arg GIT_COMMIT=\"${SEMAPHORE_GIT_SHA}\" --build-arg BUILD_TIMESTAMP=\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" ."
            - "docker push \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64\""
            - sign-images "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64"

  - name: "Dev Helm"
    dependencies: ["Test & Build"]
    run:
      when: "branch != 'main'"
    task:
      agent:
        machine:
          type: s1-prod-ubuntu24-04-arm64-0
      jobs:
        - name: "Dev Helm"
          commands:
            - echo "$(cat INTERNAL_VERSION)-$(echo $SEMAPHORE_GIT_WORKING_BRANCH | sed 's/[^a-zA-Z0-9]/-/g')+$(echo $SEMAPHORE_GIT_SHA | cut -c1-8)" > INTERNAL_VERSION
            - export ENV=dev
            - ./helm-release.sh

  - name: "Dev Create Manifest"
    dependencies: ["Dev Build AMD64", "Dev Build ARM64"]
    run:
      when: "branch != 'main'"
    task:
      env_vars:
        - name: ECR_REGISTRY
          value: "519856050701.dkr.ecr.us-west-2.amazonaws.com"
        - name: AWS_REGION
          value: "us-west-2"
        - name: IMAGE_REPOSITORY
          value: "docker/dev/confluentinc/boring-registry"
      jobs:
        - name: "Create Multi-Platform Manifest"
          commands:
            - "echo \"Creating manifest for branch: $SEMAPHORE_GIT_WORKING_BRANCH\""
            - "export INTERNAL_VERSION=\"$(echo $SEMAPHORE_GIT_WORKING_BRANCH | sed 's/[^a-zA-Z0-9]/-/g')-$(echo $SEMAPHORE_GIT_SHA | cut -c1-8)\""
            - "docker manifest create \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}\" \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-amd64\" \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}-arm64\""
            - "docker manifest push \"${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}\""
            - docker pull "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}"
            - sign-images "${ECR_REGISTRY}/${IMAGE_REPOSITORY}:${INTERNAL_VERSION}"
